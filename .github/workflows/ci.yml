name: ci

on:
  workflow_dispatch:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-Dwarnings"

jobs:

  # Nix jobs

  nix-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-nix-action
    - name: Build
      run: nix-shell --pure --command "cargo build --all-features"

  nix-test:
    runs-on: ubuntu-latest
    needs: nix-build
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-nix-action
    - name: Run tests
      run: nix-shell --pure --command "cargo test --all-features"

  nix-format:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-nix-action
    # needed to have all packages code-generated for fmt
    - name: Run cargo check
      run: nix-shell --pure --command "cargo check --all"
    - name: Run cargo fmt
      run: nix-shell --pure --command "cargo fmt --all -- --check"

  nix-coverage:
    runs-on: ubuntu-latest
    needs: nix-build
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-nix-action
    - name: Run coverage
      run: nix-shell --pure --command "cargo tarpaulin --out Lcov --out Html --workspace --all-features"
    - name: Upload HTML coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-html
        path: tarpaulin-report.html
    - name: Upload LCOV file
      uses: actions/upload-artifact@v4
      with:
        name: coverage-lcov
        path: lcov.info

  # Ubuntu jobs

  ubuntu-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-ubuntu-action
    - name: Build
      run: cargo build --all-features

  ubuntu-test:
    runs-on: ubuntu-latest
    needs: ubuntu-build
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-ubuntu-action
    - name: Install integration test dependecies
      run: sudo apt-get install -y nats-server
    - name: Run tests and integration tests
      run: NATS_SERVER_BINARY=$(which nats-server) cargo test --all-features

  ubuntu-docs-tools:
    needs: ubuntu-build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-ubuntu-action
    - name: Check help output of each tool (auto-detected)
      run: |
        set -e

        # Extract tool names from Cargo.toml
        TOOLS=$(grep -oP '(?<=^  ")tools/[^"]+(?=")' Cargo.toml | sed 's|tools/||')

        MISSING=0

        for TOOL in $TOOLS; do
          MANIFEST="tools/$TOOL/Cargo.toml"
          README="tools/$TOOL/README.md"

          echo "ðŸ” Checking tool: $TOOL"

          if [ ! -f "$MANIFEST" ]; then
            echo "::error file=$MANIFEST::Cargo.toml not found for tool $TOOL"
            MISSING=1
            continue
          fi

          if [ ! -f "$README" ]; then
            echo "::error file=$README::README.md not found for tool $TOOL"
            MISSING=1
            continue
          fi

          HELP_OUTPUT=$(cargo run --quiet --manifest-path "$MANIFEST" -- --help)

          MISSING_LINES=0
          while IFS= read -r line; do
            if ! grep -Fq "$line" "$README"; then
              echo "::warning file=$README::Missing line in README for $TOOL: $line"
              MISSING_LINES=1
            fi
          done <<< "$HELP_OUTPUT"

          if [ "$MISSING_LINES" -ne 0 ]; then
            echo "::error file=$README::Some help lines for '$TOOL' are missing in its README"
            echo "ðŸ“¢ Have you forgotten to update the documentation for $TOOL?"
            MISSING=1
          fi
        done

        if [ "$MISSING" -ne 0 ]; then
          echo "âŒ Documentation mismatch detected."
          exit 1
        else
          echo "âœ… All help outputs are documented correctly."
        fi

  ubuntu-docs-extractors:
    runs-on: ubuntu-latest
    needs: ubuntu-build
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-ubuntu-action
    - name: Check help output of each extractor (auto-detected)
      run: |
        set -e

        # Extract "extractor" names from Cargo.toml
        EXTRACTORS=$(grep -oP '(?<=^  ")extractors/[^"]+(?=")' Cargo.toml | sed 's|extractors/||')

        MISSING=0

        for EXTRACTOR in $EXTRACTORS; do
          MANIFEST="extractors/$EXTRACTOR/Cargo.toml"
          README="extractors/$EXTRACTOR/README.md"

          echo "ðŸ” Checking extractor: $EXTRACTOR"

          if [ ! -f "$MANIFEST" ]; then
            echo "::error file=$MANIFEST::Cargo.toml not found for extractor $EXTRACTOR"
            MISSING=1
            continue
          fi

          if [ ! -f "$README" ]; then
            echo "::error file=$README::README.md not found for extractor $EXTRACTOR"
            MISSING=1
            continue
          fi

          HELP_OUTPUT=$(cargo run --quiet --manifest-path "$MANIFEST" -- --help)

          MISSING_LINES=0
          while IFS= read -r line; do
            if ! grep -Fq "$line" "$README"; then
              echo "::warning file=$README::Missing line in README for $EXTRACTOR: $line"
              MISSING_LINES=1
            fi
          done <<< "$HELP_OUTPUT"

          if [ "$MISSING_LINES" -ne 0 ]; then
            echo "::error file=$README::Some help lines for '$EXTRACTOR' are missing in its README"
            echo "ðŸ“¢ Have you forgotten to update the documentation for $extractor?"
            MISSING=1
          fi
        done

        if [ "$MISSING" -ne 0 ]; then
          echo "âŒ Documentation mismatch detected."
          exit 1
        else
          echo "âœ… All help outputs are documented correctly."
        fi

  ubuntu-check-and-fmt:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-ubuntu-action
    - name: Build
      run: cargo check --all-features
    - name: Run cargo fmt
      run: cargo fmt --all -- --check

  ubuntu-lint:
    runs-on: ubuntu-latest
    needs: ubuntu-build
    steps:
    - uses: actions/checkout@v6
    - uses: ./.github/actions/setup-ubuntu-action
    - name: cargo clippy
      run: cargo clippy --all-targets --all-features
